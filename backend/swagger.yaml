openapi: 3.0.3
info:
  title: SaaS Multi-Tenant Backend Platform API
  description: |
    A comprehensive multi-tenant SaaS backend platform built with Flask.

    ## Features
    - Multi-tenant architecture with database isolation
    - JWT-based authentication with refresh tokens
    - File management with MD5 deduplication
    - Role-based access control (Admin, User, Viewer)
    - Document management system
    - Kafka integration (placeholder for Phase 6)

    ## Authentication
    Most endpoints require JWT authentication. Include the access token in the Authorization header:
    ```
    Authorization: Bearer <access_token>
    ```

    ## Rate Limiting
    API rate limiting will be implemented in Phase 6.

    ## Error Responses
    All endpoints return consistent error responses with the following structure:
    ```json
    {
      "success": false,
      "message": "Error description",
      "error": "ERROR_CODE"
    }
    ```
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:4999
    description: Development server
  - url: http://localhost:8080
    description: Docker development server
  - url: https://api.example.com
    description: Production server (Phase 7)

tags:
  - name: Authentication
    description: User authentication and session management
  - name: SSO
    description: Single Sign-On configuration and authentication
  - name: Users
    description: User profile and management
  - name: Tenants
    description: Multi-tenant management
  - name: Documents
    description: Document upload and management
  - name: Files
    description: File storage and deduplication
  - name: Kafka Demo
    description: Kafka integration demo (Phase 6 placeholder)
  - name: Health
    description: Service health checks

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token

  schemas:
    Error:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "An error occurred"
        error:
          type: string
          example: "ERROR_CODE"

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        first_name:
          type: string
          example: "John"
        last_name:
          type: string
          example: "Doe"
        email:
          type: string
          format: email
          example: "john.doe@example.com"
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"

    Tenant:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          example: "Acme Corp"
        database_name:
          type: string
          example: "tenant_acme_corp_a1b2c3d4"
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        role:
          type: string
          enum: [admin, user, viewer]
          example: "admin"
        joined_at:
          type: string
          format: date-time

    Document:
      type: object
      properties:
        id:
          type: string
          format: uuid
        filename:
          type: string
          example: "report.pdf"
        mime_type:
          type: string
          example: "application/pdf"
        file_id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        created_by:
          type: string
          format: uuid
        updated_at:
          type: string
          format: date-time

    File:
      type: object
      properties:
        id:
          type: string
          format: uuid
        md5_hash:
          type: string
          example: "5d41402abc4b2a76b9719d911017c592"
        s3_path:
          type: string
          example: "tenants/123/files/5d/41/..."
        file_size:
          type: integer
          example: 1048576
        created_at:
          type: string
          format: date-time
        document_count:
          type: integer
          example: 3
        is_orphaned:
          type: boolean
          example: false

    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total:
          type: integer
          example: 100
        pages:
          type: integer
          example: 5

    SSOConfig:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        tenant_id:
          type: string
          format: uuid
          example: "456e7890-e89b-12d3-a456-426614174000"
        provider:
          type: string
          enum: [azure_ad]
          example: "azure_ad"
        client_id:
          type: string
          example: "your-azure-client-id"
        provider_tenant_id:
          type: string
          example: "your-azure-tenant-id"
        is_enabled:
          type: boolean
          example: true
        config_metadata:
          type: object
          properties:
            auto_provisioning:
              type: object
              properties:
                enabled:
                  type: boolean
                  example: true
                default_role:
                  type: string
                  enum: [admin, user, viewer]
                  example: "viewer"
                sync_attributes_on_login:
                  type: boolean
                  example: true
                allowed_email_domains:
                  type: array
                  items:
                    type: string
                  example: ["@company.com"]
                allowed_azure_groups:
                  type: array
                  items:
                    type: string
                  example: ["All-Employees"]
                group_role_mapping:
                  type: object
                  additionalProperties:
                    type: string
                  example:
                    IT-Admins: "admin"
                    Developers: "user"
                    Readers: "viewer"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UserAzureIdentity:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        azure_object_id:
          type: string
          example: "azure-object-id-123"
        azure_upn:
          type: string
          format: email
          example: "user@company.com"
        azure_display_name:
          type: string
          example: "John Doe"
        refresh_token_encrypted:
          type: string
          description: Encrypted refresh token stored with Vault Transit Engine
        access_token_encrypted:
          type: string
          description: Encrypted access token stored with Vault Transit Engine
        token_expires_at:
          type: string
          format: date-time
        last_login:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SSOAvailability:
      type: object
      properties:
        available:
          type: boolean
          example: true
        auth_method:
          type: string
          enum: [local, sso, both]
          example: "both"
        provider:
          type: string
          enum: [azure_ad, null]
          example: "azure_ad"
        auto_provisioning:
          type: boolean
          example: true
        login_url:
          type: string
          format: uri
          example: "/api/auth/sso/azure/login/123e4567-e89b-12d3-a456-426614174000"

    SSOLoginResponse:
      type: object
      properties:
        access_token:
          type: string
          example: "jwt-access-token"
        refresh_token:
          type: string
          example: "jwt-refresh-token"
        user:
          $ref: '#/components/schemas/User'
        tenant_id:
          type: string
          format: uuid
        auth_method:
          type: string
          enum: [sso, local]
          example: "sso"
        azure_identity:
          type: object
          properties:
            object_id:
              type: string
            upn:
              type: string
            display_name:
              type: string

paths:
  /:
    get:
      tags:
        - Health
      summary: Root endpoint
      description: Returns basic service information and available endpoints
      responses:
        '200':
          description: Service information
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: "SaaS Multi-Tenant Backend Platform"
                  version:
                    type: string
                    example: "1.0.0"
                  status:
                    type: string
                    example: "running"
                  documentation:
                    type: string
                    example: "/api/docs"
                  endpoints:
                    type: object

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  service:
                    type: string
                    example: "SaaS Multi-Tenant Backend"
                  version:
                    type: string
                    example: "1.0.0"

  /api/auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: Creates a new user account with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - first_name
                - last_name
                - email
                - password
              properties:
                first_name:
                  type: string
                  minLength: 1
                  maxLength: 50
                  example: "John"
                last_name:
                  type: string
                  minLength: 1
                  maxLength: 50
                  example: "Doe"
                email:
                  type: string
                  format: email
                  example: "john.doe@example.com"
                password:
                  type: string
                  minLength: 8
                  pattern: "^(?=.*[A-Za-z])(?=.*\\d).+$"
                  example: "SecurePass123"
                  description: "Minimum 8 characters, must contain at least one letter and one number"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User registered successfully"
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticates user and returns access and refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: "admin@example.com"
                password:
                  type: string
                  example: "12345678"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Login successful"
                  access_token:
                    type: string
                    example: "eyJ0eXAiOiJKV1QiLCJhbGc..."
                  refresh_token:
                    type: string
                    example: "eyJ0eXAiOiJKV1QiLCJhbGc..."
                  user:
                    $ref: '#/components/schemas/User'
                  tenants:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Account inactive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Uses refresh token to obtain new access token
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: "eyJ0eXAiOiJKV1QiLCJhbGc..."
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: Invalidates the current access token
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out successfully"
        '401':
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/health:
    get:
      tags:
        - Authentication
        - Health
      summary: Authentication service health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  service:
                    type: string
                    example: "authentication"
                  endpoints:
                    type: object

  /api/auth/sso/detect:
    post:
      tags:
        - SSO
      summary: Detect SSO provider
      description: |
        Detects if a user's email domain has SSO configured.
        Used in login flow to redirect users to SSO automatically.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: "user@company.com"
      responses:
        '200':
          description: SSO detection result
          content:
            application/json:
              schema:
                type: object
                properties:
                  has_sso:
                    type: boolean
                    example: true
                  tenants:
                    type: array
                    items:
                      type: object
                      properties:
                        tenant_id:
                          type: string
                          format: uuid
                        tenant_name:
                          type: string
                          example: "Acme Corp"
                        provider:
                          type: string
                          enum: [azure_ad]
                        login_url:
                          type: string
                          format: uri
                          example: "/api/auth/sso/azure/login/123e4567"

  /api/auth/sso/check-availability/{tenant_id}:
    get:
      tags:
        - SSO
      summary: Check SSO availability
      description: |
        Checks if SSO is available and configured for a specific tenant.
        Returns the authentication method and SSO provider details.
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: SSO availability status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SSOAvailability'
        '404':
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/sso/azure/login/{tenant_id}:
    get:
      tags:
        - SSO
      summary: Initiate Azure AD login
      description: |
        Initiates the Azure AD OAuth2 authorization flow with PKCE.
        Redirects the user to Microsoft login page.

        **Flow:**
        1. Generates PKCE code challenge and state token
        2. Stores PKCE verifier and state in session
        3. Redirects to Microsoft authorization endpoint
        4. Microsoft redirects back to callback after authentication
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: redirect_uri
          in: query
          schema:
            type: string
            format: uri
          description: Optional custom redirect URI after successful login
      responses:
        '302':
          description: Redirect to Azure AD login page
          headers:
            Location:
              description: Microsoft authorization URL
              schema:
                type: string
                format: uri
                example: "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize?..."
        '404':
          description: SSO not configured for tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/sso/azure/callback:
    get:
      tags:
        - SSO
      summary: Azure AD OAuth2 callback
      description: |
        Handles the OAuth2 callback from Azure AD after user authentication.
        Exchanges authorization code for tokens using PKCE.
        Creates or updates user account and returns JWT tokens.

        **Flow:**
        1. Validates state token (CSRF protection)
        2. Exchanges auth code for tokens using PKCE verifier
        3. Fetches user profile from Microsoft Graph
        4. Creates/updates user and Azure identity records
        5. Returns JWT tokens for the application
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from Azure AD
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State token for CSRF protection
        - name: error
          in: query
          schema:
            type: string
          description: Error code if authentication failed
        - name: error_description
          in: query
          schema:
            type: string
          description: Error description if authentication failed
      responses:
        '200':
          description: SSO login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SSOLoginResponse'
        '400':
          description: Invalid state or authorization code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/sso/azure/refresh:
    post:
      tags:
        - SSO
      summary: Refresh Azure AD tokens
      description: |
        Refreshes Azure AD access token using stored refresh token.
        This is called automatically by background tasks before token expiry.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tenant_id
              properties:
                tenant_id:
                  type: string
                  format: uuid
                  description: UUID of the tenant
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Azure AD token refreshed successfully"
                  expires_at:
                    type: string
                    format: date-time
        '401':
          description: Refresh token invalid or expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/sso/azure/logout/{tenant_id}:
    post:
      tags:
        - SSO
      summary: Azure AD logout
      description: |
        Logs out the user from Azure AD SSO session.
        Clears stored tokens and optionally redirects to Microsoft logout.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: global_logout
          in: query
          schema:
            type: boolean
            default: false
          description: Also logout from Microsoft account globally
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO logout successful"
                  logout_url:
                    type: string
                    format: uri
                    description: Microsoft logout URL if global_logout=true

  /api/auth/sso/switch-tenant:
    post:
      tags:
        - SSO
      summary: Switch tenant with SSO
      description: |
        Switches to a different tenant using SSO authentication.
        Retrieves cached Azure AD tokens for the target tenant.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - target_tenant_id
              properties:
                target_tenant_id:
                  type: string
                  format: uuid
                  description: UUID of the tenant to switch to
      responses:
        '200':
          description: Tenant switched successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Switched to tenant successfully"
                  access_token:
                    type: string
                    description: New JWT token for the target tenant
                  tenant:
                    $ref: '#/components/schemas/Tenant'
        '404':
          description: No SSO identity found for target tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: Returns the authenticated user's profile information
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "User profile retrieved successfully"
                  data:
                    $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Users
      summary: Update current user profile
      description: Updates the authenticated user's profile (first_name and last_name only)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                first_name:
                  type: string
                  minLength: 1
                  maxLength: 50
                  example: "Jane"
                last_name:
                  type: string
                  minLength: 1
                  maxLength: 50
                  example: "Smith"
      responses:
        '200':
          description: User profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "User profile updated successfully"
                  data:
                    $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/me/tenants:
    get:
      tags:
        - Users
      summary: Get user's tenants
      description: Returns all tenants the authenticated user is a member of
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User tenants retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "User tenants retrieved successfully"
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'

  /api/users/me/sso-identities:
    get:
      tags:
        - Users
        - SSO
      summary: Get user's SSO identities
      description: |
        Returns all SSO identities linked to the authenticated user.
        A user can have different Azure Object IDs for different tenants.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: SSO identities retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO identities retrieved successfully"
                  data:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/UserAzureIdentity'
                        - type: object
                          properties:
                            tenant_name:
                              type: string
                              example: "Acme Corp"

  /api/users/me/sso-identities/{tenant_id}:
    delete:
      tags:
        - Users
        - SSO
      summary: Unlink SSO identity
      description: |
        Unlinks an SSO identity from the authenticated user for a specific tenant.
        User must have a local password set before unlinking SSO.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: SSO identity unlinked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO identity unlinked successfully"
        '400':
          description: User has no local password set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: SSO identity not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/health:
    get:
      tags:
        - Users
        - Health
      summary: Users service health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Users API is healthy"
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        example: "healthy"
                      blueprint:
                        type: string
                        example: "users"

  /api/tenants:
    get:
      tags:
        - Tenants
      summary: List user's tenants
      description: Returns all tenants the authenticated user is a member of
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Tenants retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Tenants retrieved successfully"
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'

    post:
      tags:
        - Tenants
      summary: Create a new tenant
      description: Creates a new tenant organization. Creator becomes admin.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 100
                  example: "Acme Corp"
      responses:
        '201':
          description: Tenant created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Tenant created successfully"
                  data:
                    $ref: '#/components/schemas/Tenant'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}:
    get:
      tags:
        - Tenants
      summary: Get tenant details
      description: Returns detailed information about a specific tenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: Tenant details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Tenant details retrieved successfully"
                  data:
                    allOf:
                      - $ref: '#/components/schemas/Tenant'
                      - type: object
                        properties:
                          members:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: string
                                  format: uuid
                                first_name:
                                  type: string
                                last_name:
                                  type: string
                                email:
                                  type: string
                                  format: email
                                role:
                                  type: string
                                  enum: [admin, user, viewer]
                                joined_at:
                                  type: string
                                  format: date-time
        '404':
          description: Tenant not found or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Tenants
      summary: Update tenant
      description: Updates tenant information (admin only)
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 1
                  maxLength: 100
                  example: "New Company Name"
      responses:
        '200':
          description: Tenant updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Tenant updated successfully"
                  data:
                    $ref: '#/components/schemas/Tenant'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Tenants
      summary: Delete tenant
      description: Soft deletes a tenant (admin only)
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: Tenant deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Tenant deleted successfully"
                  data:
                    type: "null"
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/users:
    post:
      tags:
        - Tenants
      summary: Add user to tenant
      description: Adds a user to the tenant with specified role (admin only)
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - role
              properties:
                user_id:
                  type: string
                  format: uuid
                  example: "123e4567-e89b-12d3-a456-426614174000"
                role:
                  type: string
                  enum: [admin, user, viewer]
                  example: "user"
      responses:
        '201':
          description: User added to tenant successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "User added to tenant successfully"
                  data:
                    type: object
                    properties:
                      user_id:
                        type: string
                        format: uuid
                      tenant_id:
                        type: string
                        format: uuid
                      role:
                        type: string
                        enum: [admin, user, viewer]
                      joined_at:
                        type: string
                        format: date-time
        '400':
          description: User already member or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/users/{target_user_id}:
    delete:
      tags:
        - Tenants
      summary: Remove user from tenant
      description: Removes a user from the tenant (admin only)
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: target_user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the user to remove
      responses:
        '200':
          description: User removed from tenant successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "User removed from tenant successfully"
                  data:
                    type: "null"
        '400':
          description: Cannot remove last admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/sso/config:
    get:
      tags:
        - Tenants
        - SSO
      summary: Get SSO configuration
      description: |
        Retrieves the SSO configuration for a tenant.
        Only tenant admins can view the configuration.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: SSO configuration retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO configuration retrieved successfully"
                  data:
                    $ref: '#/components/schemas/SSOConfig'
        '404':
          description: SSO not configured for tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags:
        - Tenants
        - SSO
      summary: Create SSO configuration
      description: |
        Creates a new SSO configuration for a tenant.
        Only tenant admins can create SSO configuration.
        Note: Client secret is not required for Azure AD public application mode.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - client_id
                - provider_tenant_id
              properties:
                provider:
                  type: string
                  enum: [azure_ad]
                  default: azure_ad
                  description: SSO provider type
                client_id:
                  type: string
                  description: Azure AD Application (client) ID
                  example: "your-azure-client-id"
                provider_tenant_id:
                  type: string
                  description: Azure AD Directory (tenant) ID
                  example: "your-azure-tenant-id"
                enable:
                  type: boolean
                  default: false
                  description: Enable SSO immediately after creation
                config_metadata:
                  type: object
                  description: Additional configuration options
                  properties:
                    auto_provisioning:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: false
                        default_role:
                          type: string
                          enum: [admin, user, viewer]
                          default: viewer
                        sync_attributes_on_login:
                          type: boolean
                          default: true
                        allowed_email_domains:
                          type: array
                          items:
                            type: string
                          example: ["@company.com"]
                        allowed_azure_groups:
                          type: array
                          items:
                            type: string
                          example: ["All-Employees"]
                        group_role_mapping:
                          type: object
                          additionalProperties:
                            type: string
                          example:
                            IT-Admins: "admin"
      responses:
        '201':
          description: SSO configuration created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO configuration created successfully"
                  data:
                    $ref: '#/components/schemas/SSOConfig'
        '400':
          description: SSO already configured or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Tenants
        - SSO
      summary: Update SSO configuration
      description: |
        Updates the SSO configuration for a tenant.
        Only tenant admins can update SSO configuration.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                client_id:
                  type: string
                  description: Azure AD Application (client) ID
                provider_tenant_id:
                  type: string
                  description: Azure AD Directory (tenant) ID
                config_metadata:
                  type: object
                  description: Additional configuration options
      responses:
        '200':
          description: SSO configuration updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO configuration updated successfully"
                  data:
                    $ref: '#/components/schemas/SSOConfig'
        '404':
          description: SSO configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Tenants
        - SSO
      summary: Delete SSO configuration
      description: |
        Deletes the SSO configuration for a tenant.
        This will disable SSO and remove all stored tokens.
        Only tenant admins can delete SSO configuration.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: SSO configuration deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO configuration deleted successfully"
        '404':
          description: SSO configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/sso/config/enable:
    post:
      tags:
        - Tenants
        - SSO
      summary: Enable SSO
      description: |
        Enables SSO for a tenant.
        SSO must be configured before it can be enabled.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: SSO enabled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO enabled successfully"
                  data:
                    type: object
                    properties:
                      is_enabled:
                        type: boolean
                        example: true
        '404':
          description: SSO configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/sso/config/disable:
    post:
      tags:
        - Tenants
        - SSO
      summary: Disable SSO
      description: |
        Disables SSO for a tenant.
        Users can still login with local passwords if available.
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: SSO disabled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO disabled successfully"
                  data:
                    type: object
                    properties:
                      is_enabled:
                        type: boolean
                        example: false
        '404':
          description: SSO configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/sso/config/validate:
    get:
      tags:
        - Tenants
        - SSO
      summary: Validate SSO configuration
      description: |
        Validates the SSO configuration by checking:
        - Azure AD app registration exists
        - Redirect URI is configured correctly
        - Required permissions are granted
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  valid:
                    type: boolean
                    example: true
                  checks:
                    type: object
                    properties:
                      app_registration:
                        type: boolean
                        description: Azure AD app exists
                      redirect_uri:
                        type: boolean
                        description: Redirect URI configured
                      permissions:
                        type: boolean
                        description: Required permissions granted
                      public_client:
                        type: boolean
                        description: Public client flow enabled
                  errors:
                    type: array
                    items:
                      type: string
                    example: []
                  warnings:
                    type: array
                    items:
                      type: string
                    example: ["Admin consent may be required"]
        '404':
          description: SSO configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/sso/config/stats:
    get:
      tags:
        - Tenants
        - SSO
      summary: Get SSO usage statistics
      description: |
        Returns statistics about SSO usage for the tenant including:
        - Number of users with SSO identities
        - Last SSO login time
        - Token refresh statistics
        - Login success/failure rates
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month, year]
            default: month
          description: Time period for statistics
      responses:
        '200':
          description: SSO statistics retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "SSO statistics retrieved successfully"
                  data:
                    type: object
                    properties:
                      total_sso_users:
                        type: integer
                        example: 42
                      active_sso_sessions:
                        type: integer
                        example: 15
                      logins_in_period:
                        type: integer
                        example: 125
                      failed_logins:
                        type: integer
                        example: 3
                      token_refreshes:
                        type: integer
                        example: 250
                      last_sso_login:
                        type: string
                        format: date-time
                      auto_provisioned_users:
                        type: integer
                        example: 8
                      by_day:
                        type: array
                        items:
                          type: object
                          properties:
                            date:
                              type: string
                              format: date
                            logins:
                              type: integer
                            refreshes:
                              type: integer
        '404':
          description: SSO configuration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/health:
    get:
      tags:
        - Tenants
        - Health
      summary: Tenants service health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Tenants API is healthy"
                  data:
                    type: object

  /api/tenants/{tenant_id}/documents:
    get:
      tags:
        - Documents
      summary: List tenant documents
      description: Returns paginated list of documents for a tenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Items per page
        - name: filename
          in: query
          schema:
            type: string
          description: Filter by filename (partial match, case-insensitive)
      responses:
        '200':
          description: Documents retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Documents retrieved successfully"
                  data:
                    type: object
                    properties:
                      documents:
                        type: array
                        items:
                          $ref: '#/components/schemas/Document'
                      pagination:
                        $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Documents
      summary: Upload document
      description: Uploads a new document to the tenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload (max 100MB)
                filename:
                  type: string
                  description: Optional filename override
                mime_type:
                  type: string
                  description: Optional MIME type override
      responses:
        '201':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Document uploaded successfully"
                  data:
                    $ref: '#/components/schemas/Document'
        '400':
          description: File too large or invalid type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/documents/{document_id}:
    get:
      tags:
        - Documents
      summary: Get document details
      description: Returns detailed information about a specific document
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the document
      responses:
        '200':
          description: Document retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Document retrieved successfully"
                  data:
                    allOf:
                      - $ref: '#/components/schemas/Document'
                      - type: object
                        properties:
                          file:
                            $ref: '#/components/schemas/File'

    put:
      tags:
        - Documents
      summary: Update document metadata
      description: Updates document filename or MIME type
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the document
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filename:
                  type: string
                  example: "Updated Report.pdf"
                mime_type:
                  type: string
                  example: "application/pdf"
      responses:
        '200':
          description: Document updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Document updated successfully"
                  data:
                    $ref: '#/components/schemas/Document'

    delete:
      tags:
        - Documents
      summary: Delete document
      description: Deletes a document (file remains if used by other documents)
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the document
      responses:
        '200':
          description: Document deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Document deleted successfully"
                  data:
                    type: object
                    properties:
                      deleted_document_id:
                        type: string
                        format: uuid
                      file_orphaned:
                        type: boolean
                        description: Whether the underlying file is now orphaned

  /api/tenants/{tenant_id}/documents/{document_id}/download:
    get:
      tags:
        - Documents
      summary: Download document file
      description: |
        Securely downloads the document file from S3 storage by proxying through the API.

        The file is streamed in chunks to avoid memory issues with large files.
        The response includes proper headers for file download with the original filename.

        **Security:**
        - Validates JWT authentication
        - Verifies user has access to the tenant
        - Does not expose direct S3 URLs
        - All downloads are logged with user_id and document_id
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the document
      responses:
        '200':
          description: File downloaded successfully
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Type:
              description: MIME type of the document
              schema:
                type: string
                example: application/pdf
            Content-Disposition:
              description: Attachment header with original filename
              schema:
                type: string
                example: 'attachment; filename="report.pdf"'
            Content-Length:
              description: Size of the file in bytes
              schema:
                type: integer
                example: 1048576
        '404':
          description: Tenant, document not found, or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error or S3 download failure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/documents/{document_id}/download-url:
    get:
      tags:
        - Documents
      summary: Generate pre-signed download URL
      description: |
        Generates a temporary pre-signed S3 URL for downloading a document without authentication.

        This endpoint requires JWT authentication to generate the URL, but the returned URL
        can be used to download the file without any authentication headers for the specified duration.

        **Use Cases:**
        - Email links to documents
        - Browser downloads without managing authentication
        - External integrations that need temporary file access
        - Sharing documents with systems that don't support Bearer tokens

        **Security:**
        - JWT authentication required to generate URL
        - User must have read permission on the tenant
        - Generated URLs expire after the specified duration (60s - 24 hours)
        - S3 bucket is private - only signed URLs work
        - All URL generations are logged with user_id and document_id

        **Important Notes:**
        - The generated URL is temporary and will expire
        - The URL includes AWS signature parameters - do not modify it
        - URLs are not reusable after expiration
        - Default expiration: 1 hour (3600 seconds)
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the document
        - name: expires_in
          in: query
          required: false
          schema:
            type: integer
            minimum: 60
            maximum: 86400
            default: 3600
          description: |
            URL expiration time in seconds.
            - Minimum: 60 seconds (1 minute)
            - Maximum: 86400 seconds (24 hours)
            - Default: 3600 seconds (1 hour)
          example: 3600
      responses:
        '200':
          description: Pre-signed URL generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Download URL generated successfully"
                  data:
                    type: object
                    properties:
                      download_url:
                        type: string
                        format: uri
                        description: Pre-signed S3 URL for downloading the document
                        example: "http://localhost:9000/saas-documents/tenants/tenant_acme_123/files/a1/b2/a1b2c3d4...?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=..."
                      expires_in:
                        type: integer
                        description: Number of seconds until the URL expires
                        example: 3600
                      expires_at:
                        type: string
                        format: date-time
                        description: ISO 8601 timestamp when the URL will expire
                        example: "2024-01-01T13:00:00Z"
                      filename:
                        type: string
                        description: Original filename of the document
                        example: "report.pdf"
                      mime_type:
                        type: string
                        description: MIME type of the document
                        example: "application/pdf"
                      file_size:
                        type: integer
                        description: Size of the file in bytes
                        example: 1048576
        '400':
          description: Invalid expires_in parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                success: false
                error: "bad_request"
                message: "expires_in must be between 60 and 86400 seconds"
        '404':
          description: Tenant or document not found, or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error or S3 URL generation failure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenant_id}/documents/health:
    get:
      tags:
        - Documents
        - Health
      summary: Documents service health check
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Documents API is healthy"
                  data:
                    type: object

  /api/files/{tenant_id}/files:
    get:
      tags:
        - Files
      summary: List tenant files
      description: Returns paginated list of files with deduplication info
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: include_stats
          in: query
          schema:
            type: boolean
            default: false
          description: Include document count and orphan status
      responses:
        '200':
          description: Files retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Files retrieved successfully"
                  data:
                    type: object
                    properties:
                      files:
                        type: array
                        items:
                          $ref: '#/components/schemas/File'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
                      stats:
                        type: object
                        properties:
                          total_files:
                            type: integer
                          total_storage_bytes:
                            type: integer
                          total_storage_mb:
                            type: number

  /api/files/{tenant_id}/files/{file_id}:
    get:
      tags:
        - Files
      summary: Get file details
      description: Returns detailed information about a specific file
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: file_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the file
      responses:
        '200':
          description: File retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "File retrieved successfully"
                  data:
                    allOf:
                      - $ref: '#/components/schemas/File'
                      - type: object
                        properties:
                          documents:
                            type: array
                            items:
                              $ref: '#/components/schemas/Document'

    delete:
      tags:
        - Files
      summary: Delete orphaned file
      description: Deletes an orphaned file (admin only)
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the tenant
        - name: file_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the file
      responses:
        '200':
          description: Orphaned file deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Orphaned file deleted successfully"
                  data:
                    type: object
                    properties:
                      file_id:
                        type: string
                        format: uuid
                      md5_hash:
                        type: string
                      freed_storage_bytes:
                        type: integer
                      freed_storage_mb:
                        type: number
        '400':
          description: File is not orphaned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/demo/kafka/produce:
    post:
      tags:
        - Kafka Demo
      summary: Produce Kafka message
      description: Demo endpoint to produce a Kafka message (placeholder)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - topic
                - message
              properties:
                topic:
                  type: string
                  example: "test.topic"
                message:
                  type: object
                  example:
                    event_type: "test"
                    data: "Hello Kafka"
                key:
                  type: string
                  example: "partition-key-123"
                  description: Optional partition key
      responses:
        '201':
          description: Kafka message sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Kafka message sent successfully"
                  data:
                    type: object
                    properties:
                      event_id:
                        type: string
                        format: uuid
                      topic:
                        type: string
                      timestamp:
                        type: string
                        format: date-time
                      status:
                        type: string
                        example: "sent"
                      note:
                        type: string
                        example: "This is a placeholder implementation..."

  /api/demo/kafka/consume:
    get:
      tags:
        - Kafka Demo
      summary: Consume Kafka messages
      description: Demo endpoint to view consumed messages (placeholder)
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          description: Maximum number of messages to return
      responses:
        '200':
          description: Kafka consumer status retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Kafka consumer status retrieved"
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        example: "running"
                      message_count:
                        type: integer
                      buffer_size:
                        type: integer
                      messages:
                        type: array
                        items:
                          type: object
                          properties:
                            event_id:
                              type: string
                              format: uuid
                            topic:
                              type: string
                            timestamp:
                              type: string
                              format: date-time
                            user_id:
                              type: string
                              format: uuid
                            key:
                              type: string
                            payload:
                              type: object
                      note:
                        type: string

  /api/demo/kafka/health:
    get:
      tags:
        - Kafka Demo
        - Health
      summary: Kafka service health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  service:
                    type: string
                    example: "kafka_demo"
                  buffer_count:
                    type: integer
                  note:
                    type: string