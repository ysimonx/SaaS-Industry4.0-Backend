openapi: 3.0.3

info:
  title: SaaS Multi-Tenant Backend Platform API
  version: 1.0.0
  description: |
    REST API for a multi-tenant SaaS platform with isolated tenant databases,
    JWT authentication, asynchronous document processing, and S3 storage.

    ## Key Features
    - **Multi-tenant Architecture**: Each tenant has isolated PostgreSQL database
    - **JWT Authentication**: Access tokens (15 min) and refresh tokens (7 days)
    - **Document Management**: Upload, store, and manage documents with MD5 deduplication
    - **File Storage**: S3-compatible storage (MinIO) with sharded path strategy
    - **Role-Based Access**: Admin, user, and viewer roles for tenant access control
    - **Kafka Integration**: Asynchronous message processing for events

    ## Authentication
    All protected endpoints require a valid JWT access token in the Authorization header:
    ```
    Authorization: Bearer <access_token>
    ```

    ## Error Responses
    All endpoints follow consistent error response format:
    ```json
    {
      "success": false,
      "error": "error_code",
      "message": "Human-readable error message",
      "details": {}
    }
    ```

  contact:
    name: API Support
    email: support@saas-platform.example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:4999
    description: Local development server
  - url: http://localhost:4999/api
    description: Local development API base
  - url: https://api.example.com
    description: Production server

tags:
  - name: Authentication
    description: User registration, login, logout, and token management
  - name: Users
    description: User profile management operations
  - name: Tenants
    description: Tenant (organization) management and user associations
  - name: Documents
    description: Document upload, retrieval, and management in tenant databases
  - name: Files
    description: File management and storage operations
  - name: Kafka Demo
    description: Demonstration endpoints for Kafka integration testing
  - name: Health
    description: Service health check endpoints

# ============================================================================
# Security Schemes
# ============================================================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT access token obtained from /api/auth/login or /api/auth/refresh.
        Token expires after 15 minutes and must be included in Authorization header.

  # ==========================================================================
  # Reusable Schemas
  # ==========================================================================
  schemas:
    # Common response wrappers
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Operation completed successfully"
        data:
          type: object
          nullable: true

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "error_code"
        message:
          type: string
          example: "Human-readable error message"
        details:
          type: object
          nullable: true

    # Pagination metadata
    PaginationMetadata:
      type: object
      properties:
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total:
          type: integer
          example: 100
        pages:
          type: integer
          example: 5

    # User schemas
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        first_name:
          type: string
          example: "John"
        last_name:
          type: string
          example: "Doe"
        email:
          type: string
          format: email
          example: "john.doe@example.com"
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"

    UserCreate:
      type: object
      required:
        - first_name
        - last_name
        - email
        - password
      properties:
        first_name:
          type: string
          minLength: 1
          maxLength: 100
          example: "John"
        last_name:
          type: string
          minLength: 1
          maxLength: 100
          example: "Doe"
        email:
          type: string
          format: email
          example: "john.doe@example.com"
        password:
          type: string
          minLength: 8
          example: "SecurePass123"
          description: Must be at least 8 characters with at least one letter and one number

    UserLogin:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "john.doe@example.com"
        password:
          type: string
          example: "SecurePass123"

    UserUpdate:
      type: object
      properties:
        first_name:
          type: string
          minLength: 1
          maxLength: 100
          example: "Jane"
        last_name:
          type: string
          minLength: 1
          maxLength: 100
          example: "Smith"

    # Tenant schemas
    Tenant:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "tenant-uuid-123"
        name:
          type: string
          example: "Acme Corp"
        database_name:
          type: string
          example: "tenant_acme_corp_a1b2c3d4"
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"

    TenantWithRole:
      allOf:
        - $ref: '#/components/schemas/Tenant'
        - type: object
          properties:
            role:
              type: string
              enum: [admin, user, viewer]
              example: "admin"
            joined_at:
              type: string
              format: date-time
              example: "2024-01-01T00:00:00Z"

    TenantCreate:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: "Acme Corp"

    TenantUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: "New Company Name"

    TenantWithMembers:
      allOf:
        - $ref: '#/components/schemas/TenantWithRole'
        - type: object
          properties:
            members:
              type: array
              items:
                allOf:
                  - $ref: '#/components/schemas/User'
                  - type: object
                    properties:
                      role:
                        type: string
                        enum: [admin, user, viewer]
                      joined_at:
                        type: string
                        format: date-time

    # User-Tenant Association schemas
    UserTenantAssociationCreate:
      type: object
      required:
        - user_id
        - role
      properties:
        user_id:
          type: string
          format: uuid
          example: "user-uuid-456"
        role:
          type: string
          enum: [admin, user, viewer]
          example: "user"

    # Document schemas
    Document:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "doc-uuid-789"
        filename:
          type: string
          example: "report.pdf"
        mime_type:
          type: string
          example: "application/pdf"
        file_id:
          type: string
          format: uuid
          example: "file-uuid-101"
        user_id:
          type: string
          format: uuid
          example: "user-uuid-456"
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"

    DocumentWithFile:
      allOf:
        - $ref: '#/components/schemas/Document'
        - type: object
          properties:
            file:
              $ref: '#/components/schemas/File'

    DocumentUpload:
      type: object
      required:
        - file
      properties:
        file:
          type: string
          format: binary
          description: File to upload (max 100MB)

    DocumentUpdate:
      type: object
      properties:
        filename:
          type: string
          minLength: 1
          maxLength: 255
          example: "updated-report.pdf"

    # File schemas
    File:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "file-uuid-101"
        md5_hash:
          type: string
          minLength: 32
          maxLength: 32
          example: "5d41402abc4b2a76b9719d911017c592"
        s3_path:
          type: string
          maxLength: 500
          example: "tenants/tenant-uuid/files/5d/41/5d41402abc4b2a76b9719d911017c592_uuid"
        file_size:
          type: integer
          format: int64
          example: 1048576
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"

    FileWithStats:
      allOf:
        - $ref: '#/components/schemas/File'
        - type: object
          properties:
            document_count:
              type: integer
              example: 3
            is_orphaned:
              type: boolean
              example: false

    # Kafka schemas
    KafkaMessage:
      type: object
      required:
        - topic
        - message
      properties:
        topic:
          type: string
          example: "test.topic"
        message:
          type: object
          example:
            event_type: "test"
            data: "Hello Kafka"
        key:
          type: string
          example: "partition-key-123"
          nullable: true

    KafkaProduceResponse:
      type: object
      properties:
        event_id:
          type: string
          format: uuid
          example: "event-uuid-202"
        topic:
          type: string
          example: "test.topic"
        timestamp:
          type: string
          format: date-time
          example: "2024-01-01T00:00:00Z"
        status:
          type: string
          example: "sent"
        note:
          type: string
          example: "This is a placeholder implementation. Kafka integration will be added in Phase 6."

    KafkaConsumeResponse:
      type: object
      properties:
        status:
          type: string
          example: "running"
        message_count:
          type: integer
          example: 5
        buffer_size:
          type: integer
          example: 10
        messages:
          type: array
          items:
            type: object
            properties:
              event_id:
                type: string
                format: uuid
              topic:
                type: string
              timestamp:
                type: string
                format: date-time
              user_id:
                type: string
                format: uuid
              key:
                type: string
                nullable: true
              payload:
                type: object
        note:
          type: string

    # Health check schema
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "healthy"
        service:
          type: string
          example: "api"
        version:
          type: string
          example: "1.0.0"

# ============================================================================
# API Endpoints
# ============================================================================
paths:
  # ==========================================================================
  # Authentication Endpoints
  # ==========================================================================
  /api/auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: |
        Creates a new user account with email and password authentication.

        **Security Features:**
        - Password must be at least 8 characters
        - Password must contain at least one letter and one number
        - Email is normalized to lowercase
        - Password is hashed with bcrypt before storage
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
            examples:
              valid:
                summary: Valid registration
                value:
                  first_name: "John"
                  last_name: "Doe"
                  email: "john.doe@example.com"
                  password: "SecurePass123"
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user:
                            $ref: '#/components/schemas/User'
              examples:
                success:
                  value:
                    success: true
                    message: "User registered successfully"
                    data:
                      user:
                        id: "123e4567-e89b-12d3-a456-426614174000"
                        first_name: "John"
                        last_name: "Doe"
                        email: "john.doe@example.com"
                        is_active: true
                        created_at: "2024-01-01T00:00:00Z"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  value:
                    success: false
                    error: "validation_error"
                    message: "Invalid user data provided"
                    details:
                      password: ["Password must be at least 8 characters"]
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                email_exists:
                  value:
                    success: false
                    error: "email_exists"
                    message: "A user with this email already exists"
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: |
        Authenticates user and returns JWT access and refresh tokens.

        **Token Expiry:**
        - Access token: 15 minutes
        - Refresh token: 7 days

        **Response includes:**
        - User profile
        - List of tenants user has access to with roles
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLogin'
            examples:
              valid:
                value:
                  email: "john.doe@example.com"
                  password: "SecurePass123"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Login successful"
                  data:
                    type: object
                    properties:
                      access_token:
                        type: string
                        example: "eyJ0eXAiOiJKV1QiLCJhbGc..."
                      refresh_token:
                        type: string
                        example: "eyJ0eXAiOiJKV1QiLCJhbGc..."
                      user:
                        $ref: '#/components/schemas/User'
                      tenants:
                        type: array
                        items:
                          $ref: '#/components/schemas/TenantWithRole'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_credentials:
                  value:
                    success: false
                    error: "invalid_credentials"
                    message: "Invalid email or password"
        '403':
          description: Account inactive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: |
        Generates a new access token using a valid refresh token.
        Refresh tokens are long-lived (7 days) while access tokens expire quickly (15 minutes).
      operationId: refreshToken
      security:
        - BearerAuth: []
      responses:
        '200':
          description: New access token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Token refreshed successfully"
                  data:
                    type: object
                    properties:
                      access_token:
                        type: string
                        example: "eyJ0eXAiOiJKV1QiLCJhbGc..."
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: |
        Logout user by blacklisting the current access token.
        Blacklisted tokens cannot be used for authentication.
        Client should also delete stored tokens.
      operationId: logoutUser
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              examples:
                success:
                  value:
                    success: true
                    message: "Logged out successfully"
        '401':
          description: Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/health:
    get:
      tags:
        - Authentication
        - Health
      summary: Authentication service health check
      operationId: authHealthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  # ==========================================================================
  # Users Endpoints
  # ==========================================================================
  /api/users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: Returns the authenticated user's profile information
      operationId: getCurrentUser
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Users
      summary: Update current user profile
      description: |
        Updates the authenticated user's profile information.
        Only first_name and last_name can be updated. Email is immutable.
      operationId: updateCurrentUser
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
            examples:
              update_name:
                value:
                  first_name: "Jane"
                  last_name: "Smith"
      responses:
        '200':
          description: User profile updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/users/me/tenants:
    get:
      tags:
        - Users
      summary: Get user's tenants
      description: |
        Returns a list of all tenants the authenticated user has access to,
        along with their role in each tenant.
      operationId: getCurrentUserTenants
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User tenants retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/TenantWithRole'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/users/health:
    get:
      tags:
        - Users
        - Health
      summary: Users service health check
      operationId: usersHealthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  # ==========================================================================
  # Tenants Endpoints
  # ==========================================================================
  /api/tenants:
    get:
      tags:
        - Tenants
      summary: List user's tenants
      description: |
        Returns a list of all tenants the authenticated user is a member of,
        along with their role in each tenant.
      operationId: listTenants
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Tenants retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/TenantWithRole'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Tenants
      summary: Create new tenant
      description: |
        Creates a new tenant with isolated database. Automatically:
        - Generates a unique database name
        - Creates the isolated tenant database
        - Adds the creator as an admin
      operationId: createTenant
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantCreate'
            examples:
              create:
                value:
                  name: "Acme Corp"
      responses:
        '201':
          description: Tenant created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/TenantWithRole'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/{tenant_id}:
    get:
      tags:
        - Tenants
      summary: Get tenant details
      description: |
        Returns detailed information about a specific tenant, including
        a list of all members with their roles.
      operationId: getTenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
      responses:
        '200':
          description: Tenant details retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/TenantWithMembers'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Tenant not found or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Tenants
      summary: Update tenant
      description: |
        Updates tenant name. Only tenant admins can perform this operation.
      operationId: updateTenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantUpdate'
            examples:
              update:
                value:
                  name: "New Company Name"
      responses:
        '200':
          description: Tenant updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Tenant'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not a tenant admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Tenants
      summary: Delete tenant
      description: |
        Soft deletes a tenant by marking it as inactive.
        Only tenant admins can perform this operation.
        The tenant database is NOT dropped - manual cleanup required.
      operationId: deleteTenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
      responses:
        '200':
          description: Tenant deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not a tenant admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/{tenant_id}/users:
    post:
      tags:
        - Tenants
      summary: Add user to tenant
      description: |
        Adds an existing user to a tenant with a specified role.
        Only tenant admins can perform this operation.
      operationId: addUserToTenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserTenantAssociationCreate'
            examples:
              add_user:
                value:
                  user_id: "456e7890-e12b-34d5-b678-901234567890"
                  role: "user"
      responses:
        '201':
          description: User added to tenant successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          user_id:
                            type: string
                            format: uuid
                          tenant_id:
                            type: string
                            format: uuid
                          role:
                            type: string
                          joined_at:
                            type: string
                            format: date-time
        '400':
          description: Validation error or user already in tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not a tenant admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/{tenant_id}/users/{user_id}:
    delete:
      tags:
        - Tenants
      summary: Remove user from tenant
      description: |
        Removes a user's access to a tenant.
        Only tenant admins can perform this operation.
        Admins cannot remove themselves if they are the last admin.
      operationId: removeUserFromTenant
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: User UUID to remove
      responses:
        '200':
          description: User removed from tenant successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Cannot remove last admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not a tenant admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/health:
    get:
      tags:
        - Tenants
        - Health
      summary: Tenants service health check
      operationId: tenantsHealthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  # ==========================================================================
  # Documents Endpoints
  # ==========================================================================
  /api/tenants/{tenant_id}/documents:
    get:
      tags:
        - Documents
      summary: List documents
      description: |
        Returns paginated list of documents in tenant database.
        Supports filtering by filename.
      operationId: listDocuments
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Items per page
        - name: filename
          in: query
          schema:
            type: string
          description: Filter by filename (partial match, case-insensitive)
      responses:
        '200':
          description: Documents retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          documents:
                            type: array
                            items:
                              $ref: '#/components/schemas/Document'
                          pagination:
                            $ref: '#/components/schemas/PaginationMetadata'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Tenant not found or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Documents
      summary: Upload document
      description: |
        Uploads a new document with file to tenant database.
        Supports MD5 deduplication - if file already exists, it will be reused.
        Maximum file size: 100MB.
      operationId: uploadDocument
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload (max 100MB)
      responses:
        '201':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DocumentWithFile'
        '400':
          description: Validation error or file too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/{tenant_id}/documents/{document_id}:
    get:
      tags:
        - Documents
      summary: Get document details
      description: Returns detailed information about a specific document
      operationId: getDocument
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Document UUID
      responses:
        '200':
          description: Document retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/DocumentWithFile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Documents
      summary: Update document
      description: Updates document metadata (filename only)
      operationId: updateDocument
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Document UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentUpdate'
      responses:
        '200':
          description: Document updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Document'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Documents
      summary: Delete document
      description: |
        Deletes a document. Only the document owner can perform this operation.
        The underlying file is NOT deleted if other documents reference it.
      operationId: deleteDocument
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Document UUID
      responses:
        '200':
          description: Document deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not the document owner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tenants/{tenant_id}/documents/{document_id}/download:
    get:
      tags:
        - Documents
      summary: Get document download URL
      description: Returns a pre-signed S3 URL for downloading the document
      operationId: getDocumentDownloadUrl
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Document UUID
      responses:
        '200':
          description: Download URL generated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          download_url:
                            type: string
                            format: uri
                            example: "https://s3.example.com/bucket/path?signature=..."
                          expires_in:
                            type: integer
                            example: 3600
                            description: URL expiry time in seconds
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # Files Endpoints
  # ==========================================================================
  /api/files/{tenant_id}/files:
    get:
      tags:
        - Files
      summary: List files
      description: |
        Returns paginated list of all files in tenant database with optional statistics.
        Files are immutable and shared across documents via MD5 deduplication.
      operationId: listFiles
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Items per page
        - name: include_stats
          in: query
          schema:
            type: boolean
            default: false
          description: Include document count and orphan status
      responses:
        '200':
          description: Files retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          files:
                            type: array
                            items:
                              oneOf:
                                - $ref: '#/components/schemas/File'
                                - $ref: '#/components/schemas/FileWithStats'
                          pagination:
                            $ref: '#/components/schemas/PaginationMetadata'
                          stats:
                            type: object
                            properties:
                              total_files:
                                type: integer
                              total_storage_bytes:
                                type: integer
                              total_storage_mb:
                                type: number
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Tenant not found or access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/files/{tenant_id}/files/{file_id}:
    get:
      tags:
        - Files
      summary: Get file details
      description: Returns detailed information about a specific file with document references
      operationId: getFile
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: file_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: File UUID
      responses:
        '200':
          description: File retrieved successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        allOf:
                          - $ref: '#/components/schemas/FileWithStats'
                          - type: object
                            properties:
                              documents:
                                type: array
                                items:
                                  $ref: '#/components/schemas/Document'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: File not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Files
      summary: Delete orphaned file
      description: |
        Deletes an orphaned file (file not referenced by any documents).
        Only tenant admins can perform this operation.
        Safety check: File must have no document references.
      operationId: deleteFile
      security:
        - BearerAuth: []
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant UUID
        - name: file_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: File UUID
      responses:
        '200':
          description: File deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: File is not orphaned (has document references)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Not a tenant admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # Kafka Demo Endpoints
  # ==========================================================================
  /api/demo/kafka/produce:
    post:
      tags:
        - Kafka Demo
      summary: Produce test message
      description: |
        Sends a test message to Kafka topic for demonstration purposes.

        **NOTE:** This is a demo endpoint. Actual Kafka integration will be implemented in Phase 6.
        Messages are stored in in-memory buffer for testing.
      operationId: produceKafkaMessage
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KafkaMessage'
            examples:
              test_message:
                value:
                  topic: "test.events"
                  message:
                    event_type: "ping"
                    data: "Hello Kafka"
                  key: "test-partition-123"
      responses:
        '201':
          description: Message sent successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/KafkaProduceResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/demo/kafka/consume:
    get:
      tags:
        - Kafka Demo
      summary: Get consumer status
      description: |
        Returns Kafka consumer status and last consumed messages from in-memory buffer.

        **NOTE:** This is a demo endpoint showing in-memory buffer.
        Real consumer will run in separate worker process.
      operationId: getKafkaConsumerStatus
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 50
          description: Maximum number of messages to return
      responses:
        '200':
          description: Consumer status retrieved
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/KafkaConsumeResponse'
        '400':
          description: Invalid limit parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/demo/kafka/health:
    get:
      tags:
        - Kafka Demo
        - Health
      summary: Kafka demo service health check
      operationId: kafkaDemoHealthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/HealthResponse'
                  - type: object
                    properties:
                      buffer_count:
                        type: integer
                      note:
                        type: string

  # ==========================================================================
  # Global Health Check
  # ==========================================================================
  /health:
    get:
      tags:
        - Health
      summary: Global API health check
      description: Returns overall API health status
      operationId: globalHealthCheck
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  message:
                    type: string
                    example: "SaaS Platform API is running"
                  version:
                    type: string
                    example: "1.0.0"
                  services:
                    type: object
                    properties:
                      database:
                        type: string
                        example: "connected"
                      kafka:
                        type: string
                        example: "connected"
                      s3:
                        type: string
                        example: "connected"
